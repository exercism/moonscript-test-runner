#!/usr/bin/env sh

# Synopsis:
# Test the test runner Docker image by running it against the example solutions
# from the language track.  The test runner Docker image is built
# automatically.  The track is cloned from git into a subdirectory.

# Output:
# The actual test results generated by the test runner Docker image.

# Example:
# ./bin/validate-track-in-docker.sh

# Stop executing when a command returns a non-zero return code
set -e

# Fetch the moonscript track
rm -rf track/
git clone --depth 1 https://github.com/exercism/moonscript.git track

# Build the Docker image
docker build --rm -t exercism/moonscript-test-runner .

# Run the Docker image using the settings mimicking the production environment
docker run \
    --rm \
    --network none \
    --read-only \
    --mount type=bind,src="${PWD}/track",dst=/opt/test-runner/track \
    --mount type=tmpfs,dst=/tmp \
    --workdir /opt/test-runner \
    --entrypoint /opt/test-runner/track/bin/verify-exercises \
    exercism/moonscript-test-runner
